<html>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script type="text/javascript">
    var canvas, ctx, flag = false,
        prevX = 0,
        currX = 0,
        prevY = 0,
        currY = 0,
        dot_flag = false;


    function init() {
        document.body.addEventListener("touchstart", function(e){ if (e.target.nodeName == 'CANVAS') { e.preventDefault(); } }, false);
        document.body.addEventListener("touchend", function(e){ if (e.target.nodeName == 'CANVAS') { e.preventDefault(); } }, false);
        document.body.addEventListener("touchmove", function(e){ if (e.target.nodeName == 'CANVAS') { e.preventDefault(); } }, false);


        const image = document.getElementById('source');
        var url = new URL(window.location.href);
        var c = url.searchParams.get("image");
        image.src = 'pictures/'+c+'.jpg'

        image.onload = () => {
            canvas = document.getElementById('can');
            ctx = canvas.getContext("2d");
            w = canvas.width;
            h = canvas.height;
            ctx.clearRect(0, 0, w, h);
            canvascontainer = document.getElementById('canvascontainer')

            canvas.addEventListener("mousemove", function (e) {
                findxy('move', e, false)
            }, false);
            canvas.addEventListener("touchmove", function (e) {
                findxy('move', e, true)
            }, false);
            canvas.addEventListener("mousedown", function (e) {
                findxy('down', e, false)
            }, false);
            canvas.addEventListener("touchstart", function (e) {
                findxy('down', e, true)
            }, false);
            canvas.addEventListener("mouseup", function (e) {
                findxy('up', e, false)
            }, false);
            canvas.addEventListener("touchend", function (e) {
                findxy('up', e, true)
            }, false);
            canvas.addEventListener("mouseout", function (e) {
                findxy('out', e, false)
            }, false);

            const image2 = document.getElementById('source');
            ctx.drawImage(image2,0,0,w,h);
        }


    }

    function correctX(x){
        canvas = document.getElementById('can')
        return x*(canvas.width/canvas.clientWidth)
    }

    function correctY(y){
        canvas = document.getElementById('can')
        return y*(canvas.height/canvas.clientHeight)
    }

    function draw() {
        ctx.beginPath();
        ctx.moveTo(correctX(prevX), correctX(prevY));
        ctx.lineTo(correctY(currX), correctY(currY));
        ctx.strokeStyle = 'red';
        ctx.lineWidth = "10";
        ctx.stroke();
        ctx.closePath();
    }

    function erase() {
        var m = confirm("Want to clear");
        if (m) {
            init()
        }
    }

    function save() {
        var dataURL = canvas.toDataURL();

        (async () => {
            const rawResponse = await fetch('/log', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({a: 1, b: 'Textual content', image: dataURL})
            });
            const content = await rawResponse.json();

            console.log(content);
        })();
    }

    function findxy(res, e, isTouch) {
        let clientX = NaN
        let clientY = NaN
        if (e.touches && e.touches.length > 0){
            clientX = e.touches[0].clientX
            clientY = e.touches[0].clientY
        }
        else {
            clientX = e.clientX
            clientY = e.clientY
        }
        if (res == 'down') {
            prevX = currX;
            prevY = currY;

            currX = clientX - canvas.offsetLeft;
            currY = clientY - canvas.offsetTop;

            flag = true;
            dot_flag = true;
            if (dot_flag) {
                ctx.beginPath();
                ctx.fillStyle = x;
                ctx.fillRect(currX, currY, 2, 2);
                ctx.closePath();
                dot_flag = false;
            }
        }
        if (res == 'up' || res == "out") {
            flag = false;
        }
        if (res == 'move') {
            if (flag) {
                prevX = currX;
                prevY = currY;
                currX = clientX - canvas.offsetLeft;
                currY = clientY - canvas.offsetTop;
                //alert(`draw (${prevX},${prevY}) to (${currX},${currY})`)
                draw();
            }
        }
    }
</script>
<body onload="init()">
<div id="canvascontainer" style="max-width: 90%;overflow: hidden;position: relative">
    <canvas id="can" width="2000" height="1333" style="position:absolute;max-height:100%;max-width:100%;z-index: 1000;touch-action: none"></canvas>
    <img id="source"
         src="pictures/WhatsApp%20Image%202019-07-06%20at%2018.13.34.jpeg"
         style="opacity: 0;position: relative;width:100%">
</div>

<!--<div style="position:absolute;top:12%;left:43%;">Choose Color</div>-->
<!--<div style="position:absolute;top:15%;left:45%;width:10px;height:10px;background:green;" id="green" onclick="color(this)"></div>-->
<!--<div style="position:absolute;top:15%;left:46%;width:10px;height:10px;background:blue;" id="blue" onclick="color(this)"></div>-->
<!--<div style="position:absolute;top:15%;left:47%;width:10px;height:10px;background:red;" id="red" onclick="color(this)"></div>-->
<!--<div style="position:absolute;top:17%;left:45%;width:10px;height:10px;background:yellow;" id="yellow" onclick="color(this)"></div>-->
<!--<div style="position:absolute;top:17%;left:46%;width:10px;height:10px;background:orange;" id="orange" onclick="color(this)"></div>-->
<!--<div style="position:absolute;top:17%;left:47%;width:10px;height:10px;background:black;" id="black" onclick="color(this)"></div>-->
<!--<div style="position:absolute;top:20%;left:43%;">Eraser</div>-->
<!--<div style="position:absolute;top:22%;left:45%;width:15px;height:15px;background:white;border:2px solid;" id="white" onclick="color(this)"></div>-->
<img id="canvasimg" style="position:absolute;top:10%;left:52%;" style="display:none;">
<input type="button" value="save" id="btn" size="30" onclick="save()" style="position:fixed;bottom:10%;left:10%;z-index:2000">
<input type="button" value="clear" id="clr" size="23" onclick="erase()" style="position:fixed;bottom:10%;left:15%;z-index: 2000">

<div style="display:none;">

</div>
</body>
</html>